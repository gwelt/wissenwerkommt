<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<script>
// Polyfills
if ((!Array.prototype.includes)||(!Array.prototype.find)) {loadScript('polyfills.js',afterPolyfill)}
function loadScript(src, done) {
  var js = document.createElement('script');
  js.src = src;
  js.onload = function() {
    done(src+' executed');
  };
  document.head.appendChild(js);
}
function afterPolyfill(m) {debug(m)}
// Service-Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(function(reg){
      debug("The service worker registered.");
    }).catch(function(err) {
      debug("Something went wrong while registering the service worker. This happened: ", err)
    });
}

var team=false;
var adminMode=false;

function checkSize() {
  var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
  debug('clientWidth: '+width);
}

function updateView(json) {  
  team=json?JSON.parse(json):false;
  if (team.userlevel<2) {adminMode=false}
  var mobile_head=document.getElementById('mobile_head');
  var mobile_main=document.getElementById('mobile_main');
  var mobile_options=document.getElementById('mobile_options');
  var mobile_admin=document.getElementById('mobile_admin');

  var selected='';
  var preset_weekday=(team.recurrence)&&(team.recurrence[0].weekday)?team.recurrence[0].weekday:new Date().getDay();
  var preset_hour=(team.recurrence)&&(team.recurrence[0].time)?team.recurrence[0].time.slice(0,2):new Date().getHours();
  var preset_minute=(team.recurrence)&&(team.recurrence[0].slice)?team.recurrence[0].time.slice(3,5):(Math.floor(new Date().getMinutes()/15)*15);
  var weekdays=[[1,'montags'],[2,'dienstags'],[3,'mittwochs'],[4,'donnerstags'],[5,'freitags'],[6,'samstags'],[0,'sonntags'],[7,'täglich'],[8,'unregelmäßig']];

  var weekday_selection='<select id="weekday" onchange="display_hour_selection()">';
  var i=-1;
  while (++i<weekdays.length) {
    if (preset_weekday==weekdays[i][0]) {selected=' selected'} else {selected=''}
    weekday_selection+='<option value="'+weekdays[i][0]+'"'+selected+'>'+weekdays[i][1]+'</option>';
  }
  weekday_selection+='</select>';

  var hour_selection='<select id="hour">';
  var hour=-1; while (++hour<24) {
    hour<10?hour='0'+hour:true;
    if (hour==preset_hour) {selected=' selected'} else {selected=''}
    hour_selection+='<option value="'+hour+'"'+selected+'>'+hour+'</option>';
  }
  hour_selection+='</select>';

  var minute_selection='<select id="minute">';
  var minute=0; while (minute<60) {
    minute<10?minute='0'+minute:true;
    if (minute==preset_minute) {selected=' selected'} else {selected=''}
    minute_selection+='<option value="'+minute+'"'+selected+'>'+minute+'</option>';minute=minute*1+15;
  }
  minute_selection+='</select>';

  var svg_menu='<svg xmlns="http://www.w3.org/2000/svg" id="svg_menu" fill="#000" width="24px" height="18px" viewBox="0 0 24 24"><path d="M24 6h-24v-4h24v4zm0 4h-24v4h24v-4zm0 8h-24v4h24v-4z"/></svg>';

  mobile_head.innerHTML="<button onclick=toggleView('mobile_options')>"+svg_menu+"</button>";

  if (!team) {
    // MAIN-page if no team is requested
    var admin_options_button='';
    serverRequest('getUserLevel',{'token':getCookie('token',true)},function (userlevel){
      if (userlevel>1) {admin_options_button=' <button onclick=\'toggleView("mobile_options","none");setAdminMode()\'>toggle Admin-Options</button>'} else {adminMode=false; setAdminMode(adminMode);}
      mobile_options.innerHTML='<button onclick=\'toggleView("mobile_options","none");askCookie("name");\'>'+(getCookie("name",true)||"your name")+'</button> <button onclick=\'toggleView("mobile_options","none");askCookie("token")\'>'+(getCookie("token",true)||"set token")+'</button>'+admin_options_button+'<hr>';
    });
    mobile_main.innerHTML='CREATE A NEW TEAM<br><input type="text" id="name" value="" placeholder="name of the team"><br>'+weekday_selection+' '+hour_selection+' '+minute_selection +'<br><input type="text" id="teamid" value="'+window.location.pathname.substr(1)+'" placeholder="team id"><br><input type="text" id="admintoken" value="'+(team.admintoken||'')+'" placeholder="admin token"><!--<br>teamtoken: --><input type="hidden" id="teamtoken" value="'+(team.teamtoken||'')+'"><br><button onclick=addTeam()>create Team</button>';
    mobile_admin.innerHTML='ADMIN: <button onclick=load()>load</button> <button onclick=save()>save</button> <button onclick=dump()>dump</button>'
    serverRequest('getListOfTeamIDs',{},function (r){mobile_main.innerHTML+="<hr>Teams: "; r=JSON.parse(r); r.forEach(function (t){mobile_main.innerHTML+='<a href=/'+t+'>'+t+'</a> '})});
    // serverRequest('stats',{},function (r){mobile_main.innerHTML+="<br>Here are some stats: "+r});
  } else {
    // TEAM-page
    var admin_options_button='';
    if (team.userlevel>1) {admin_options_button=' <button onclick=\'toggleView("mobile_options","none");setAdminMode()\'>toggle Admin-Options</button>'} else {adminMode=false}
    mobile_options.innerHTML='<button onclick=\'toggleView("mobile_options","none");askCookie("name");\'>'+(getCookie("name",true)||"your name")+'</button> <button onclick=\'toggleView("mobile_options","none");askCookie("token")\'>'+(getCookie("token",true)||"set token")+'</button>'+admin_options_button+'<hr>';
    if (team.error) {
      debug('ERROR: The server answered: '+JSON.stringify(team))
      mobile_main.innerHTML=team.error+'<br>Maybe you need to <a href="/'+window.location.pathname.substr(1)+'" onclick=askCookie(\'token\')>set a(nother) token</a>?';
      mobile_main.innerHTML+='<hr><a href=/>zur Startseite</a>';
      //getCookie('token');
    } else {
      mobile_head.innerHTML+=" <a href=/"+team.teamid+" style=text-decoration:none>"+(!!team.name?team.name:'')+"</a>";
      var name=getCookie('name',true);
      mobile_main.innerHTML='';
      team.events?team.events.forEach(function (e) {
        var comment='<div class="admin" style="display:none"> <input type="text" id="comment'+e.datetime+'" value="'+(e.comment||'')+'"> <button onclick=commentEvent("'+e.datetime+'")>comment event</button></div>';
        var day=['So','Mo','Di','Mi','Do','Fr','Sa'][new Date(e.datetime).getDay()]+' '+e.datetime.substring(8,10)+'.'+e.datetime.substring(5,7)+'. '+e.datetime.substring(11,16)+' Uhr';
        mobile_main.innerHTML+='<button id="status'+e.datetime+'" onclick=toggleStatus("'+e.datetime+'")>'+day+'</button> '
        +' ('+(!e.attendees?0:e.attendees.length)+') '
        +(!e.attendees?'':'JA:'+e.attendees)+' '
        +(!e.refusals?'':'NEIN:'+e.refusals)+'<br>'+comment;

        if (e.attendees&&e.attendees.includes(name)) {document.getElementById('status'+e.datetime).className='button_attending'}
        else if (e.refusals&&e.refusals.includes(name)) {document.getElementById('status'+e.datetime).className='button_refused'} 
        else {document.getElementById('status'+e.datetime).className=''}

      }):false;
      mobile_main.innerHTML+='<hr><a href=/>zur Startseite</a>';
      
      mobile_admin.innerHTML='<input type="hidden" id="teamid" value="'+window.location.pathname.substr(1)+'"><input type="text" id="name" value="'+(team.name||'')+'" placeholder="name of the team"><br><input type="text" id="teamtoken" value="'+(team.teamtoken||'')+'" placeholder="team token"><br><input type="text" id="admintoken" value="'+(team.admintoken||'')+'" placeholder="admin token"><br>'+weekday_selection+' '+hour_selection+' '+minute_selection +'<br><button onclick=editTeam()>update Team</button> <button onclick=deleteTeam()>delete Team</button><hr><input type="text" id="datetime" value="'+getDateString()+'T00:00" placeholder="datetime"><br><input type="text" id="comment" value="Einzeltermin" placeholder="comment"><br><button onclick=addEvent()>add Event</button><hr>';

      debug('Team-JSON: '+JSON.stringify(team));
    }    
  }
  display_hour_selection();
  setAdminMode(adminMode);
}

function display_hour_selection() {
	var viewstate='inline';
  var element_weekday=document.getElementById('weekday');
  if (element_weekday) {
    if (element_weekday.value==8) {viewstate='none'}
    document.getElementById('hour').style.display=viewstate;
    document.getElementById('minute').style.display=viewstate;    
  }
}

// set/toggle view of admin-options
function setAdminMode(state) {
  if (state==undefined) {adminMode=!adminMode} else {adminMode=state}
  if (adminMode) {
    [].forEach.call(document.getElementsByClassName('admin'), function (c) {c.style.display='block'});
  } else {
    [].forEach.call(document.getElementsByClassName('admin'), function (c) {c.style.display='none'});
  }
}

function toggleStatus(datetime) {
  var e=findEvent(team,datetime);
  var name=getCookie('name',true);
  if (e.attendees&&e.attendees.includes(name)) {changeStatus("refuse",datetime)}
  else if (e.refusals&&e.refusals.includes(name)) {changeStatus("undecided",datetime)} 
  else {changeStatus("attend",datetime)}
}

function toggleView(id,state) {
  var e=document.getElementById(id);
  if (state) {e.style.display=state} 
  else if (e.currentStyle?e.currentStyle.display=='none':getComputedStyle(e, null).display=='none') {e.style.display='block'} else {e.style.display='none'}
}

function findEvent(team,datetime) {
  if (team.events instanceof Array) {
    return team.events.find(function(e) {return e.datetime==datetime})||false;
  } else {return false}
}

function updateStatus(json) {
  debug('The server answered: '+json);
  //var o=JSON.parse(json);
  getTeam();
}

function getTeam(teamid) {
  if (!teamid) {teamid=window.location.pathname.substr(1)}
  if (teamid) {
    serverRequest('getTeam',{token:getCookie('token',true),teamid:teamid},function (r){updateView(r)});
  } else {updateView()}
}

function changeStatus(status,datetime) {
  serverRequest(status,{token:getCookie('token',!team.teamtoken),teamid:window.location.pathname.substr(1),datetime:datetime,name:getCookie('name')},function (r){updateStatus(r);});
}

function addTeam() {
  serverRequest('addTeam',{teamid:document.getElementById('teamid').value,name:document.getElementById('name').value,teamtoken:document.getElementById('teamtoken').value,admintoken:document.getElementById('admintoken').value,recurrence:[{weekday:document.getElementById('weekday').value,time:document.getElementById('hour').value+':'+document.getElementById('minute').value}]},function (r){if (JSON.parse(r).hasOwnProperty('teamid')) {window.location.href = '/'+document.getElementById('teamid').value;} else {debug(r)}});
}

function editTeam() {
  serverRequest('editTeam',{token:getCookie('token',true),teamid:document.getElementById('teamid').value,name:document.getElementById('name').value,teamtoken:document.getElementById('teamtoken').value,admintoken:document.getElementById('admintoken').value,recurrence:[{weekday:document.getElementById('weekday').value,time:document.getElementById('hour').value+':'+document.getElementById('minute').value}]},function (r){updateStatus(r);});
}

function deleteTeam() {
  serverRequest('deleteTeam',{token:getCookie('token',true),teamid:document.getElementById('teamid').value},function (r){updateStatus(r);});
}

function addEvent() {
  serverRequest('addEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:document.getElementById('datetime').value,comment:document.getElementById('comment').value},function (r){updateStatus(r);});
}

function cancelEvent(datetime) {
  serverRequest('cancelEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r);});
}

function reviveEvent(datetime) {
  serverRequest('reviveEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r);});
}

function commentEvent(datetime) {
  serverRequest('commentEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime,comment:document.getElementById('comment'+datetime).value},function (r){updateStatus(r);});
}

function deleteEvent(datetime) {
  serverRequest('deleteEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r);});
}

function load() {
  serverRequest('load',{token:getCookie('token',true)},function (r){updateStatus(r);});
}

function save() {
  serverRequest('save',{token:getCookie('token',true)},function (r){updateStatus(r);});
}

function dump() {
  serverRequest('dump',{token:getCookie('token',true)},function (r){updateStatus(r);});
}

function getDateString(d) {
  if (!d) {d=new Date()}
  var tzoffset = d.getTimezoneOffset() * 60000;
  return (new Date(d-tzoffset)).toISOString().slice(0, -14);
} 

function serverRequest(apicall,json,callback) {
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {if (this.readyState == 4) {callback(this.responseText)}};
  req.open("POST","/api/"+apicall,true);
  req.setRequestHeader("Content-Type","application/json;charset=UTF-8");
  req.send(JSON.stringify(json));
}

function getCookie(cname,dontask) {
  var name = cname + "=";
  var ca = document.cookie.split(';');
  for(var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      var res=c.substring(name.length, c.length);
      return res;
    }
  }
  if (dontask) {return} else {return askCookie(cname)}
}

function askCookie(cname) {
  var preval=getCookie(cname,true);
  var val = prompt("Please enter "+cname, preval);
  return setCookie(cname, val, 365); //-1 = sessioncookie
}

function setCookie(cname, cvalue, exdays) {
  var expires='';
  if (cvalue==""||cvalue==null) {exdays=0} //0 = delete cookie
  if (exdays>=0) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    expires = "expires="+d.toUTCString();
  }
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  getTeam();
  return getCookie(cname,true);
}

function debug(text) {
  console.log(text);
}

is_mobile=1;
function check_mobile() 
{
  var old_mobile_status=is_mobile;
  var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
  var height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
  if ( (width<=1024) && (is_mobile!=-1) )//|| ((display_state(document.getElementById('mobile'))==='block')&&(is_mobile!=-1)) ) 
  {
    is_mobile=1;
    document.getElementById('under_mobile').style.display='none';
    document.getElementById('mobile').style.maxWidth='100vw';
    document.getElementById('mobile').style.height='100vh';
    document.getElementById('mobile').style.top=0;
    document.querySelector("meta[name=viewport]").setAttribute('content','initial-scale=1');
  }
  else 
  {
    if (is_mobile>0) {is_mobile=0}
    document.getElementById('under_mobile').style.display='block';
    var width=380; 
    document.getElementById('mobile').style.maxWidth=width+'px'; 
    document.getElementById('under_mobile').style.backgroundSize=width+58+'px 100%';
    document.getElementById('mobile').style.height='85%';
    document.getElementById('mobile').style.top='8%';
    document.querySelector("meta[name=viewport]").setAttribute('content','width=1024,initial-scale=1');
  }
  if (old_mobile_status!=is_mobile) {}
}

</script>

<style>
/* roboto-slab-regular - latin-ext */
@font-face {
  font-family: 'Roboto Slab';
  font-style: normal;
  font-weight: 400;
  src: url('/fonts/roboto-slab-v7-latin-ext-regular.eot'); /* IE9 Compat Modes */
  src: local('Roboto Slab Regular'), local('RobotoSlab-Regular'),
       url('/fonts/roboto-slab-v7-latin-ext-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('/fonts/roboto-slab-v7-latin-ext-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('/fonts/roboto-slab-v7-latin-ext-regular.woff') format('woff'), /* Modern Browsers */
       url('/fonts/roboto-slab-v7-latin-ext-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('/fonts/roboto-slab-v7-latin-ext-regular.svg#RobotoSlab') format('svg'); /* Legacy iOS */
}
/* roboto-regular - latin-ext */
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 400;
  src: url('/fonts/roboto-v18-latin-ext-regular.eot'); /* IE9 Compat Modes */
  src: local('Roboto'), local('Roboto-Regular'),
       url('/fonts/roboto-v18-latin-ext-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('/fonts/roboto-v18-latin-ext-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('/fonts/roboto-v18-latin-ext-regular.woff') format('woff'), /* Modern Browsers */
       url('/fonts/roboto-v18-latin-ext-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('/fonts/roboto-v18-latin-ext-regular.svg#Roboto') format('svg'); /* Legacy iOS */
}
  * {-webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;}
  body {padding:0; margin:0; background-color:#fff;font-family: 'Roboto', serif; font-size: 1.6em; color:#000; background-color:#fff;}
  /*
    green #86E082 #5BCF55 #3BBA34 #1DA416 #0E8108
    red   #FE9395 #FD686C #E34044 #C81B20 #9E090D
    brown #FFC393 #FFAC69 #E58A41 #CA691B #A04C0A
    blue  #6FBFBC #409B98 #278B87 #117B77 #06615E
  */
  .bigscreen {
    height:100vh;
    position:relative;
  }
  .under_mobile {
    position: fixed; 
    z-index:-1;
    width:100%; height:100%;
    background: url(images/phone.svg);
    background-repeat: no-repeat;
    background-position: top center;
    background-size: 490px 100%;
  }
  .mobile {background-color: #fff; padding:0; position:relative; z-index:99; overflow:auto; margin:auto;}
    .head {background-color:rgb(200,200,200); padding:0.8%;}
    .main {background-color: #fff; padding:0.8%;}
    .options {background-color: #fff; padding:0.8%; display:none;}
    .admin {display:none}

  #mobile_admin {background-color: #fff; padding:0.8%;}
  #svg_menu {fill:#000;}
  /*#svg_menu:hover {fill:#ff0000;}*/
  a {color:inherit}
  a:hover {color:rgb(0,0,0); nobackground-color:rgb(245,0,0); notext-decoration:none; nopadding: 0 0.5em 0 0.5em; border-radius: 0.2em;}
  hr {border-color: rgb(0,0,0)}
  select, input, button {font-family: 'Roboto', serif; font-size: 1em; padding: 0 0.5em 0 0.5em; border-style: none; border-radius: 0.2em; background-color:rgb(235,235,235); outline:0; height:50px; margin:0 0 4px 0;}
 
  button {
    position: relative; overflow: hidden; display:inline-block; cursor: pointer; background-color:#f2f2f2; background-image:linear-gradient(#f2f2f2 84%,#e8e8e8 0%); height:50px;
    letter-spacing: -0.9px; text-transform: uppercase; text-align: center;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.16), 0 1px 1px rgba(0, 0, 0, 0.1);
  }
  button:before {
    -webkit-transition: 0.22s all ease;
    transition: 0.22s all ease;
    position: absolute;
    top: 92%;
    left: 0;
    bottom: 0;
    content: '';
    background-color: #000;
    opacity: 0.4;
    z-index: 2;
  }
  button:hover:before {
    top: 84%;
    right: 0;
    opacity: 0.24;
  }
  .button_attending {cursor: pointer; background-color:#1DA416; background-image:linear-gradient(#1DB416 84%,#1DA416 0%);}
  .button_refused {cursor: pointer; background-color:#C81B20; background-image:linear-gradient(#D81B20 84%,#C81B20 0%);}

/* Extra small devices (phones, 600px and down) */
@media only screen and (max-width: 600px) {} 

/* Small devices (portrait tabvars and large phones, 600px and up) */
@media only screen and (min-width: 600px) {} 

/* Medium devices (landscape tabvars, 768px and up) */
@media only screen and (min-width: 768px) {} 

/* Large devices (laptops/desktops, 992px and up) */
@media only screen and (min-width: 1024px) {
  body {
    background-color:#000; 
    background-image:linear-gradient(#1DB416 78%, #1DA416 0%);
  }
  .mobile {
    border-radius: 0.4em;
  }
  
} 

/* Extra large devices (large laptops and desktops, 1200px and up) */
@media only screen and (min-width: 1200px) {}

</style>

</head>
<body onload="getTeam();check_mobile();" onresize="check_mobile()">

<div id="bigscreen" class="bigscreen">
  <div id="under_mobile" class="under_mobile"><img src=/images/logout.svg style=position:fixed;bottom:10px;right:10px;width:60px></div>
  <div id="mobile" class="mobile">
    <div id="mobile_head" class="head"></div>
    <div id="mobile_options" class="options"></div>
    <div id="mobile_admin" class="admin"></div>
    <div id="mobile_main" class="main"></div>
  </div>
</div>
<!--<audio id="audio" no_controls="" no_autoplay><source src="sounds/smb_kick.wav" type="audio/wav">audio not supported</audio><button onclick=document.getElementById("audio").play()>play audio</button>-->

</body>

</html>
