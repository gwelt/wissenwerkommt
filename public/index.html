<!DOCTYPE html>
<html>
<body onload="updateWelcomeMessage();getTeam();">

<div id="welcomemessage"></div>
<div id="main"></div>
<div id="reply"></div>

<script>

var team=false;
function updateView(json) {  
  team=json?JSON.parse(json):false;
  let main=document.getElementById("main");
  let weekday_selection='<select id="weekday"><option value="1">montags</option><option value="2">dienstags</option><option value="3">mittwochs</option><option value="4">donnerstags</option><option value="5">freitags</option><option value="6">samstags</option><option value="0">sonntags</option></select>';
  let hour_selection='<select id="hour">';
  let hour=-1; while (++hour<24) {hour<10?hour='0'+hour:true;hour_selection+='<option value="'+hour+'">'+hour+'</option>'}
  hour_selection+='</select>';
  let minute_selection='<select id="minute">';
  let minute=0; while (minute<60) {minute<10?minute='0'+minute:true;minute_selection+='<option value="'+minute+'">'+minute+'</option>';minute=minute*1+15;}
  minute_selection+='</select>';
  if (!team||team.error) {
		// MAIN-page if no team is requested
    if (team.error) {document.getElementById("reply").innerHTML = '<br>The server answered: '+JSON.stringify(team);}
		main.innerHTML='teamid:<input type="text" id="teamid" value="'+window.location.pathname.substr(1)+'"> name:<input type="text" id="name" value=""> teamtoken:<input type="text" id="teamtoken" value="'+(team.teamtoken||'')+'"> admintoken:<input type="text" id="admintoken" value="'+(team.admintoken||'')+'"> '+weekday_selection+' '+hour_selection+' '+minute_selection +' <button onclick=addTeam()>create Team</button> &nbsp; <button onclick=load()>load</button> <button onclick=save()>save</button> <button onclick=dump()>dump</button>';
  	serverRequest('getListOfTeamIDs',{},(r)=>{main.innerHTML+="<br>Here is a list of all teams: "; r=JSON.parse(r); r.forEach((t)=>{main.innerHTML+='<a href=/'+t+'>'+t+'</a> '})});
  	serverRequest('stats',{},(r)=>{main.innerHTML+="<br>Here are some stats: "+r});
  } else {
		// TEAM-page
		main.innerHTML='<h2><a href=/'+team.teamid+'>'+team.name+'</a></h2>';
    main.innerHTML+='<input type="hidden" id="teamid" value="'+window.location.pathname.substr(1)+'"> name:<input type="text" id="name" value="'+team.name+'"> teamtoken:<input type="text" id="teamtoken" value="'+(team.teamtoken||'')+'"> admintoken:<input type="text" id="admintoken" value="'+(team.admintoken||'')+'"> '+weekday_selection+' '+hour_selection+' '+minute_selection +' <button onclick=editTeam()>update Team</button> <button onclick=deleteTeam()>delete Team</button><br>';
    main.innerHTML+='<br>datetime:<input type="text" id="datetime" value="'+getDateString()+'T00:00"> comment:<input type="text" id="comment" value="Einzeltermin"> <button onclick=addEvent()>add Event</button><br><br>';
		team.events?team.events.forEach(function (e) {
			main.innerHTML+=['So','Mo','Di','Mi','Do','Fr','Sa'][new Date(e.datetime).getDay()]+' '+e.datetime+' ('+(!e.attendees?0:e.attendees.length)+') '
			+'<button onclick=changeStatus("attend","'+e.datetime+'")>attend</button> '
			+'<button onclick=changeStatus("refuse","'+e.datetime+'")>refuse</button> '
			+'<button onclick=changeStatus("undecided","'+e.datetime+'")>undecided</button> '
			+'<button onclick=cancelEvent("'+e.datetime+'")>cancel event</button> '
			+'<button onclick=reviveEvent("'+e.datetime+'")>revive event</button> '
			+'<button onclick=deleteEvent("'+e.datetime+'")>delete event</button> '
      +'<input type="text" id="comment'+e.datetime+'" value="'+(e.comment||'')+'"> '
      +'<button onclick=commentEvent("'+e.datetime+'")>comment event</button> '
			+(!e.attendees?'':'JA:'+e.attendees)+' '
			+(!e.refusals?'':'NEIN:'+e.refusals)+'<br>';
		}):false;
		main.innerHTML += '<br>Team-JSON: '+JSON.stringify(team);
  }
}

function updateStatus(json) {
  let o=JSON.parse(json);
  document.getElementById("reply").innerHTML = '<br>The server answered: '+JSON.stringify(o);
  getTeam();
}

function updateWelcomeMessage() {
  document.getElementById('welcomemessage').innerHTML='<a href=/>Welcome</a>, <button onclick=askCookie("name")>'+(getCookie('name',true)||'click here')+'</button> <button onclick=askCookie("token")>'+(getCookie('token',true)||'set token')+'</button>.';
}


function getTeam(teamid) {
  if (!teamid) {teamid=window.location.pathname.substr(1)};
  if (teamid) {
    serverRequest('getTeam',{token:getCookie('token',true),teamid:teamid},(r)=>{updateView(r)});
  } else {updateView()}
}

function changeStatus(status,datetime) {
  serverRequest(status,{token:getCookie('token',!team.teamtoken),teamid:window.location.pathname.substr(1),datetime:datetime,name:getCookie('name')},(r)=>{updateStatus(r)});
}

function addTeam() {
  serverRequest('addTeam',{teamid:document.getElementById('teamid').value,name:document.getElementById('name').value,teamtoken:document.getElementById('teamtoken').value,admintoken:document.getElementById('admintoken').value,recurrence:[{weekday:document.getElementById('weekday').value,time:document.getElementById('hour').value+':'+document.getElementById('minute').value}]},(r)=>{updateStatus(r)});
}

function editTeam() {
	serverRequest('editTeam',{token:getCookie('token',true),teamid:document.getElementById('teamid').value,name:document.getElementById('name').value,teamtoken:document.getElementById('teamtoken').value,admintoken:document.getElementById('admintoken').value,recurrence:[{weekday:document.getElementById('weekday').value,time:document.getElementById('hour').value+':'+document.getElementById('minute').value}]},(r)=>{updateStatus(r)});
}

function deleteTeam() {
	serverRequest('deleteTeam',{token:getCookie('token',true),teamid:document.getElementById('teamid').value},(r)=>{updateStatus(r)});
}

function addEvent() {
	serverRequest('addEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:document.getElementById('datetime').value,comment:document.getElementById('comment').value},(r)=>{updateStatus(r)});
}

function cancelEvent(datetime) {
	serverRequest('cancelEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},(r)=>{updateStatus(r)});
}

function reviveEvent(datetime) {
	serverRequest('reviveEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},(r)=>{updateStatus(r)});
}

function commentEvent(datetime) {
	serverRequest('commentEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime,comment:document.getElementById('comment'+datetime).value},(r)=>{updateStatus(r)});
}

function deleteEvent(datetime) {
	serverRequest('deleteEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},(r)=>{updateStatus(r)});
}

function load() {
	serverRequest('load',{token:getCookie('token',true)},(r)=>{updateStatus(r)});
}

function save() {
	serverRequest('save',{token:getCookie('token',true)},(r)=>{updateStatus(r)});
}

function dump() {
	serverRequest('dump',{token:getCookie('token',true)},(r)=>{updateStatus(r)});
}

function getDateString(d) {
  if (!d) {d=new Date()};
  var tzoffset = d.getTimezoneOffset() * 60000;
  return (new Date(d-tzoffset)).toISOString().slice(0, -14);
} 

function serverRequest(apicall,json,callback) {
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {if (this.readyState == 4 && this.status == 200) {callback(this.responseText)}};
  req.open("POST","/api/"+apicall,true);
  req.setRequestHeader("Content-Type","application/json;charset=UTF-8");
  req.send(JSON.stringify(json));
}

function askCookie(cname) {
  preval=getCookie(cname,true);
  val = prompt("Please enter "+cname, preval);
  return setCookie(cname, val, -1); //-1 = sessioncookie
}

function setCookie(cname, cvalue, exdays) {
	var expires='';
	if (cvalue==""||cvalue==null) {exdays=0} //0 = delete cookie
  if (exdays>=0) {
  	var d = new Date();
  	d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
  	expires = "expires="+d.toUTCString();
  }
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  updateWelcomeMessage(); 
  return cvalue;
  //return getCookie(cname,true);
}

function getCookie(cname,dontask) {
  var name = cname + "=";
  var ca = document.cookie.split(';');
  for(var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
    	let res=c.substring(name.length, c.length);
    	//if (cname=='name') {updateWelcomeMessage(res)};
    	return res;
    }
  }
  if (!dontask) {return askCookie(cname)} else {return undefined};
}

</script>

</body>
</html>
