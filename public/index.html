<!DOCTYPE html>
<html>
<head>
<script>

var team=false;
function updateView(json) {  
  team=json?JSON.parse(json):false;
  let main=document.getElementById("main");
  let selected='';
  let preset_weekday=(team.recurrence)?team.recurrence[0].weekday:0;
  let preset_hour=(team.recurrence)?team.recurrence[0].time.slice(0,2):0;
  let preset_minute=(team.recurrence)?team.recurrence[0].time.slice(3,5):0;
  let weekdays=[[1,'montags'],[2,'dienstags'],[3,'mittwochs'],[4,'donnerstags'],[5,'freitags'],[6,'samstags'],[0,'sonntags'],[7,'täglich'],[8,'unregelmäßig']];

  let weekday_selection='<select id="weekday">';
  let i=-1;
  while (++i<weekdays.length) {
    if (preset_weekday==weekdays[i][0]) {selected=' selected'} else {selected=''}
    weekday_selection+='<option value="'+weekdays[i][0]+'"'+selected+'>'+weekdays[i][1]+'</option>';
  }
  weekday_selection+='</select>';

  let hour_selection='<select id="hour">';
  let hour=-1; while (++hour<24) {
    hour<10?hour='0'+hour:true;
    if (hour==preset_hour) {selected=' selected'} else {selected=''}
    hour_selection+='<option value="'+hour+'"'+selected+'>'+hour+'</option>';
  }
  hour_selection+='</select>';

  let minute_selection='<select id="minute">';
  let minute=0; while (minute<60) {
    minute<10?minute='0'+minute:true;
    if (minute==preset_minute) {selected=' selected'} else {selected=''}
    minute_selection+='<option value="'+minute+'"'+selected+'>'+minute+'</option>';minute=minute*1+15;
  }
  minute_selection+='</select>';

  if ((!team||team.error)&&(!window.location.pathname.substr(1))) {
    // MAIN-page if no team is requested
    if (team.error) {document.getElementById("reply").innerHTML = '<br>The server answered: '+JSON.stringify(team);}
    mobile_main.innerHTML='<hr>CREATE A NEW TEAM<br>teamid:<input type="text" id="teamid" value="'+window.location.pathname.substr(1)+'"> name:<input type="text" id="name" value=""> '+weekday_selection+' '+hour_selection+' '+minute_selection +'<br>teamtoken:<input type="text" id="teamtoken" value="'+(team.teamtoken||'')+'"> admintoken:<input type="text" id="admintoken" value="'+(team.admintoken||'')+'"> <button onclick=addTeam()>create Team</button><hr>ADMIN: <button onclick=load()>load</button> <button onclick=save()>save</button> <button onclick=dump()>dump</button><hr>';
    serverRequest('getListOfTeamIDs',{},function (r){mobile_main.innerHTML+="Here is a list of all teams: "; r=JSON.parse(r); r.forEach(function (t){mobile_main.innerHTML+='<a href=/'+t+'>'+t+'</a> '})});
    serverRequest('stats',{},function (r){mobile_main.innerHTML+="<br>Here are some stats: "+r});
  } else {
    // TEAM-page
    mobile_main.innerHTML="<a href=/>Hallo</a> <button onclick=askCookie('name')>"+(getCookie('name',true)||'click here')+"</button> <button onclick=askCookie('token')>"+(getCookie('token',true)||'set token')+"</button>. Team: <a href=/"+team.teamid+">"+team.name+"</a> <span id='userlevel'></span><br>";
    mobile_main.innerHTML+="<div id='mobile_admin' style='display:none'></div>";
    team.events?team.events.forEach(function (e) {
      mobile_main.innerHTML+=['So','Mo','Di','Mi','Do','Fr','Sa'][new Date(e.datetime).getDay()]+' '+e.datetime+' ('+(!e.attendees?0:e.attendees.length)+') '
      +'<button id="status'+e.datetime+'" onclick=toggleStatus("'+e.datetime+'")>'+getStatus(e.datetime)+'</button> '
      +'<input type="text" id="comment'+e.datetime+'" value="'+(e.comment||'')+'"> '
      +'<button onclick=commentEvent("'+e.datetime+'")>comment event</button> '
      +(!e.attendees?'':'JA:'+e.attendees)+' '
      +(!e.refusals?'':'NEIN:'+e.refusals)+'<br>';
    }):false;
    
    mobile_admin.innerHTML='<input type="hidden" id="teamid" value="'+window.location.pathname.substr(1)+'"> name:<input type="text" id="name" value="'+team.name+'"> teamtoken:<input type="text" id="teamtoken" value="'+(team.teamtoken||'')+'"> admintoken:<input type="text" id="admintoken" value="'+(team.admintoken||'')+'"> '+weekday_selection+' '+hour_selection+' '+minute_selection +' <button onclick=editTeam()>update Team</button> <button onclick=deleteTeam()>delete Team</button><br><br>datetime:<input type="text" id="datetime" value="'+getDateString()+'T00:00"> comment:<input type="text" id="comment" value="Einzeltermin"> <button onclick=addEvent()>add Event</button><br><br>';

    debug('Team-JSON: '+JSON.stringify(team));    
    getUserLevel();  
  }
}

function getStatus(datetime) {
  let e=findEvent(team,datetime);
  let name=getCookie('name',true);
  if (e.attendees&&e.attendees.includes(name)) {return 'A'}
  else if (e.refusals&&e.refusals.includes(name)) {return 'R'} 
  else {return '?'}
}

function findEvent(team,datetime) {
  if (team.events instanceof Array) {
    return team.events.find(e => e.datetime==datetime)||false;
  } else {return false}
}

function toggleStatus(datetime) {
  switch (getStatus(datetime)) {
    case 'A':
      changeStatus("refuse",datetime);
      break;
    case 'R':
      changeStatus("undecided",datetime);
      break;
    case '?':
      changeStatus("attend",datetime);
      break;
  }
}

function getUserLevel(teamid) {
  if (!teamid) {teamid=window.location.pathname.substr(1)};
  if (teamid) {
    serverRequest('getUserLevel',{token:getCookie('token',true),teamid:teamid},function (r){
      document.getElementById('userlevel').innerHTML='(Level '+r+')';
      if (r>1) {document.getElementById('mobile_admin').style.display='block'}
    });
  }
}

function updateStatus(json) {
  let o=JSON.parse(json);
  debug('The server answered: '+JSON.stringify(o));
  getTeam();
}

function getTeam(teamid) {
  if (!teamid) {teamid=window.location.pathname.substr(1)};
  if (teamid) {
    serverRequest('getTeam',{token:getCookie('token',true),teamid:teamid},function (r){updateView(r)});
  } else {updateView()}
}

function changeStatus(status,datetime) {
  serverRequest(status,{token:getCookie('token',!team.teamtoken),teamid:window.location.pathname.substr(1),datetime:datetime,name:getCookie('name')},function (r){updateStatus(r)});
}

function addTeam() {
  serverRequest('addTeam',{teamid:document.getElementById('teamid').value,name:document.getElementById('name').value,teamtoken:document.getElementById('teamtoken').value,admintoken:document.getElementById('admintoken').value,recurrence:[{weekday:document.getElementById('weekday').value,time:document.getElementById('hour').value+':'+document.getElementById('minute').value}]},function (r){updateStatus(r)});
}

function editTeam() {
  serverRequest('editTeam',{token:getCookie('token',true),teamid:document.getElementById('teamid').value,name:document.getElementById('name').value,teamtoken:document.getElementById('teamtoken').value,admintoken:document.getElementById('admintoken').value,recurrence:[{weekday:document.getElementById('weekday').value,time:document.getElementById('hour').value+':'+document.getElementById('minute').value}]},function (r){updateStatus(r)});
}

function deleteTeam() {
  serverRequest('deleteTeam',{token:getCookie('token',true),teamid:document.getElementById('teamid').value},function (r){updateStatus(r)});
}

function addEvent() {
  serverRequest('addEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:document.getElementById('datetime').value,comment:document.getElementById('comment').value},function (r){updateStatus(r)});
}

function cancelEvent(datetime) {
  serverRequest('cancelEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r)});
}

function reviveEvent(datetime) {
  serverRequest('reviveEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r)});
}

function commentEvent(datetime) {
  serverRequest('commentEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime,comment:document.getElementById('comment'+datetime).value},function (r){updateStatus(r)});
}

function deleteEvent(datetime) {
  serverRequest('deleteEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r)});
}

function load() {
  serverRequest('load',{token:getCookie('token',true)},function (r){updateStatus(r)});
}

function save() {
  serverRequest('save',{token:getCookie('token',true)},function (r){updateStatus(r)});
}

function dump() {
  serverRequest('dump',{token:getCookie('token',true)},function (r){updateStatus(r)});
}

function getDateString(d) {
  if (!d) {d=new Date()};
  var tzoffset = d.getTimezoneOffset() * 60000;
  return (new Date(d-tzoffset)).toISOString().slice(0, -14);
} 

function serverRequest(apicall,json,callback) {
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {if (this.readyState == 4) {callback(this.responseText)}};
  req.open("POST","/api/"+apicall,true);
  req.setRequestHeader("Content-Type","application/json;charset=UTF-8");
  req.send(JSON.stringify(json));
}

function askCookie(cname) {
  preval=getCookie(cname,true);
  val = prompt("Please enter "+cname, preval);
  return setCookie(cname, val, -1); //-1 = sessioncookie
}

function setCookie(cname, cvalue, exdays) {
  var expires='';
  if (cvalue==""||cvalue==null) {exdays=0} //0 = delete cookie
  if (exdays>=0) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    expires = "expires="+d.toUTCString();
  }
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  getTeam();
  return cvalue;
}

function getCookie(cname,dontask) {
  var name = cname + "=";
  var ca = document.cookie.split(';');
  for(var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      let res=c.substring(name.length, c.length);
      return res;
    }
  }
  if (dontask) {return undefined} else {return askCookie(cname)};
}

function debug(text) {
  console.log(text);
}

</script>

<style>
  .body {max-width:800px}
  .mobile_main {background-color:#fff; max-width:800px;}
</style>

</head>
<body onload="getTeam()" class="body">

<!--<div id="main" class="main"></div>-->
<div id="mobile_main" class="mobile_main"></div>
<div id="reply"></div>
<div id="debug"></div>

</body>
</html>
