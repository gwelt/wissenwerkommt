<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="images/apple-touch-icon-precomposed.png">
<script>
// Polyfills
if ((!Array.prototype.includes)||(!Array.prototype.find)) {loadScript('polyfills.js',afterPolyfill)}
function loadScript(src, done) {
  var js = document.createElement('script');
  js.src = src;
  js.onload = function() {
    done(src+' executed');
  };
  document.head.appendChild(js);
}
function afterPolyfill(m) {debug(m)}
// Service-Worker
/*
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(function(reg){
      debug("The service worker registered.");
    }).catch(function(err) {
      debug("Something went wrong while registering the service worker. This happened: ", err)
    });
}
*/

var team=false;
var team_datetime_selection='';

function updateView(json) {  
  team=json?JSON.parse(json):false;
  var mobile_head=document.getElementById('mobile_head');
  var mobile_main=document.getElementById('mobile_main');
  var mobile_options=document.getElementById('mobile_options');
  //var mobile_admin=document.getElementById('mobile_admin');
  var mobile_footer=document.getElementById('mobile_footer');
  var selected='';

  // prepare weekday-selection
  var weekdays=[[1,'montags'],[2,'dienstags'],[3,'mittwochs'],[4,'donnerstags'],[5,'freitags'],[6,'samstags'],[0,'sonntags'],[7,'täglich'],[8,'unregelmäßig']];
  var preset_weekday=(team.recurrence)&&(team.recurrence[0].weekday)?team.recurrence[0].weekday:new Date().getDay();
  var weekday_selection='<select style="width:100%" id="weekday" onchange="display_hour_selection()">';
  var teams_weekday='';
  var i=-1;
  while (++i<weekdays.length) {
    if (preset_weekday==weekdays[i][0]) {selected=' selected'; teams_weekday=weekdays[i][1]} else {selected=''}
    weekday_selection+='<option value="'+weekdays[i][0]+'"'+selected+'>'+weekdays[i][1]+'</option>';
  }
  weekday_selection+='</select>';

  // prepare time-selection
  var preset_hour=(team.recurrence)&&(team.recurrence[0].time)?team.recurrence[0].time.slice(0,2):new Date().getHours();
  var hour_selection='<select id="hour">';
  var hour=-1; while (++hour<24) {
    hour<10?hour='0'+hour:true;
    if (hour==preset_hour) {selected=' selected'} else {selected=''}
    hour_selection+='<option value="'+hour+'"'+selected+'>'+hour+'</option>';
  }
  hour_selection+='</select>';
  var preset_minute=(team.recurrence)&&(team.recurrence[0].time)?team.recurrence[0].time.slice(3,5):(Math.floor(new Date().getMinutes()/5)*5);
  var minute_selection='<select id="minute">';
  var minute=0; while (minute<60) {
    minute<10?minute='0'+minute:true;
    if (minute==preset_minute) {selected=' selected'} else {selected=''}
    minute_selection+='<option value="'+minute+'"'+selected+'>'+minute+'</option>';
    minute=minute*1+5;
  }
  minute_selection+='</select>';

  team_datetime_selection=weekday_selection+'<br>'+hour_selection+' '+minute_selection;

  var teams_hour=(team.recurrence)&&(team.recurrence[0].time)?team.recurrence[0].time.slice(0,2):'';
  var teams_minute=(team.recurrence)&&(team.recurrence[0].time)?team.recurrence[0].time.slice(3,5):'';
  var teams_weekday_time=(teams_weekday!='unregelmäßig'?teams_weekday:'')+" "+((teams_hour)?teams_hour+':'+teams_minute:'');

  // HEAD
  var svg_menu='<svg xmlns="http://www.w3.org/2000/svg" id="svg_menu" fill="#000" width="24px" height="18px" viewBox="0 0 24 24"><path d="M24 6h-24v-4h24v4zm0 4h-24v4h24v-4zm0 8h-24v4h24v-4z"/></svg>';

  mobile_head.innerHTML="<div class='head_wrapper'><button class='option_button' onclick=toggleView('mobile_options');toggleView('mobile_main');>"+svg_menu+"</button><a href=/ style=text-decoration:none;font-weight:bold>wissenwerkommt</a><br><div style=font-size:0.7em>Startseite</div></div>";
  mobile_footer.innerHTML="<div id='footer_wrapper' class='footer_wrapper'><div style=font-size:0.7em;text-align:center>Immer besser zu <a href=/>wissenwerkommt</a>.</div></div>"; //<div style=height:8px></div><a href="+window.location+">"+window.location+"</a>

  // MENU
  var text='';
  var cookie=undefined;
  var svg='';
  var menu='';
  var admin_menu='';

  // MENU:NAME
  text='Mit welchem Namen möchtest du dich anmelden?';
  cookie=getCookie("name",true);
  if (cookie) {text='Hallo <b>'+cookie+'</b>.<br>Schön, dass du da bist.'}
  svg='';//<svg xmlns="http://www.w3.org/2000/svg" id="svg_menu" fill="#000" width="24px" height="18px" viewBox="0 0 24 24"><path d="M24 6h-24v-4h24v4zm0 4h-24v4h24v-4zm0 8h-24v4h24v-4z"/></svg>';
  menu+='<div class="options_option"><button class="option_button" onclick="show_cookie_prompt(\'name\');">'+svg+'</button><div class="option_text">'+text+'</div></div>';

  // MENU:TOKEN
  cookie=getCookie("token",true);
  text='Für den Zugriff kann die Eingabe eines Token notwendig sein.';
  if (cookie) {text='Dein Token:<br><b>'+cookie+'</b>'}
  svg='';//<svg xmlns="http://www.w3.org/2000/svg" id="svg_menu" fill="#000" width="24px" height="18px" viewBox="0 0 24 24"><path d="M24 6h-24v-4h24v4zm0 4h-24v4h24v-4zm0 8h-24v4h24v-4z"/></svg>';
  menu+='<div class="options_option"><button class="option_button" onclick="show_cookie_prompt(\'token\');">'+svg+'</button><div class="option_text">'+text+'</div></div>';

  if (!team) {
 
    // MAIN-page if no team is requested
    /*
    serverRequest('getUserLevel',{'token':getCookie('token',true)},function (userlevel) {
      if (userlevel>2) {} else {}
    });
    */
    mobile_main.innerHTML='<div class="new_team_wrapper"><input type="text" id="name" value="" placeholder="name of your team" autocomplete="off"><br>'+weekday_selection+'<br>'+hour_selection+' '+minute_selection +'<br><input type="text" id="teamid" value="'+window.location.pathname.substr(1)+'" placeholder="team id" autocomplete="off"><br><input type="text" id="admintoken" value="'+(team.admintoken||'')+'" placeholder="admin token" autocomplete="off"><input type="hidden" id="teamtoken" value="'+(team.teamtoken||'')+'" autocomplete="off"><br><button onclick=addTeam()>create Team</button></div><div class="teamlist_wrapper" id="teamlist"><br>Teams: </div>';
    //mobile_admin.innerHTML='<button onclick=load()>load</button><button onclick=save()>save</button><button onclick=dump()>dump</button>'
    mobile_footer.innerHTML="";//<div id='footer_wrapper' class='footer_wrapper'>Teams: </div>";
    serverRequest('getListOfTeamIDs',{},function (r){r=JSON.parse(r); r.forEach(function (t){document.getElementById('teamlist').innerHTML+='<a href=/'+t+'>'+t+'</a> '})});
    //serverRequest('stats',{},function (r){mobile_main.innerHTML+="<br>Here are some stats: "+r});
 
  } else {
 
    admin_menu+='<div class="divider">Termine</div>';
    // ADMIN_MENU:NEW EVENT
    admin_menu+='<div class="options_option"><button class="option_button" onclick="show_teamAddEvent_prompt()"></button><div class="option_text">Termin hinzufügen</div></div>';
    // ADMIN_MENU:DATETIME
    admin_menu+='<div class="options_option"><button class="option_button" onclick="show_teamPreferenceDatetime_prompt()"></button><div class="option_text">Terminserie:<br><b>'+(teams_weekday_time!=' '?teams_weekday_time:'keine (unregelmäßig)')+'</b></div></div>';
    admin_menu+='<div class="divider">Team</div>';
    // ADMIN_MENU:TEAM-NAME
    admin_menu+='<div class="options_option"><button class="option_button" onclick="show_teamPreference_prompt(\'<b>Name</b> des Teams:\',\'name\',\''+(team.name?team.name:'')+'\',\'\');"></button><div class="option_text">Name des Teams:<br><b>'+team.name+'</b></div></div>';
    // ADMIN_MENU:TEAM-ID
    admin_menu+='<div class="options_option"><button class="option_button" onclick="show_teamPreference_prompt(\'<b>Team-ID</b> / Aufruf-URL:\',\'new_teamid\',\''+(team.teamid?team.teamid:'')+'\',\'Achtung! Mit der Team-ID veränderst du auch den Aufruf-Link (URL) für dein Team!\');"></button><div class="option_text">ID des Teams:<br><b>'+team.teamid+'</b></div></div>';
    // ADMIN_MENU:ADMIN-TOKEN
    admin_menu+='<div class="options_option"><button class="option_button" onclick="show_teamPreference_prompt(\'<b>Admin-Token</b>:\',\'admintoken\',\''+(team.admintoken?team.admintoken:'')+'\',\'Achtung! Wenn du den Admin-Token veränderst, wirst du gleich selbst nicht mehr Admin sein. Du musst den Token dann erst selbst neu angeben!\');"></button><div class="option_text">Admin-Token:<br><b>'+team.admintoken+'</b></div></div>';
    // ADMIN_MENU:TEAM-TOKEN
    admin_menu+='<div class="options_option"><button class="option_button" onclick="show_teamPreference_prompt(\'<b>Team-Token</b>:\',\'teamtoken\',\''+(team.teamtoken?team.teamtoken:'')+'\',\'Vergiss nicht, deinem Team den neuen Team-Token mitzuteilen!\');"></button><div class="option_text">Team-Token:<br><b>'+team.teamtoken+'</b></div></div>';
    // ADMIN_MENU:DELETE TEAM
    admin_menu+='<div class="options_option"><button class="option_button" onclick="show_teamDeleteTeam_prompt()"></button><div class="option_text">Team löschen</div></div>';

    if (team.error) {
      // MAIN-page if a team is requested but not found or not allowed
      debug('ERROR: The server answered: '+JSON.stringify(team))
      mobile_head.innerHTML="<div class='head_wrapper'><button class='option_button' onclick=toggleView('mobile_options');toggleView('mobile_main');>"+svg_menu+"</button><a href=/ style=text-decoration:none;font-weight:bold>wissenwerkommt</a><br><div style=font-size:0.7em>/<a href=/"+window.location.pathname.substr(1)+">"+window.location.pathname.substr(1)+"</a></div></div>";
      mobile_main.innerHTML='<div class="error_wrapper"><div class="error_text">Der Zugriff ist geschützt.<br>Das Team hat einen Code vereinbart:<br><br></div><button style="width:100%" onclick=show_cookie_prompt(\'token\')>Token eingeben</button></div>';
    } else {
 
      // MAIN-page if a team is requested
      mobile_head.innerHTML="<div class='head_wrapper'><button class='option_button' onclick=toggleView('mobile_options');toggleView('mobile_main');>"+svg_menu+"</button><a href=/"+team.teamid+" style=text-decoration:none;font-weight:bold>"+(!!team.name?team.name:'')+"</a><br><div style=font-size:0.7em>"+teams_weekday_time+"</div></div>";
      var name=getCookie('name',true);
      mobile_main.innerHTML='';

      // display each event
      var event_counter=0;
      team.events?team.events.forEach(function (e) {
        event_counter++;

        var comment_inline='';
        if (e.comment) {comment_inline='<div class="comment_wrapper">'+(e.comment?e.comment:'')+'</div>';}
        var comment_important='';
        if (e.cancelled) {comment_important='<div class=comment_important>TERMIN FÄLLT AUS</div>';}

        // prepare content
        var peoples_list='';
        if (e.attendees) {e.attendees.forEach(function (att) {peoples_list+='<div class="attendee_item">'+att+'</div>'});}
        if (e.refusals) {e.refusals.forEach(function (ref) {peoples_list+='<div class="refusal_item">'+ref+'</div>'});}
        
        // calculate time to go till event starts
        var time_to_go_till_event_starts='';
        var minutes_to_go=Math.floor((new Date(e.datetime)-new Date())/60000)+1;
        if (minutes_to_go<1) {time_to_go_till_event_starts='gestartet'}
        else if (minutes_to_go<5) {time_to_go_till_event_starts='startet gleich'}
        else if (minutes_to_go<60) {time_to_go_till_event_starts='startet in '+minutes_to_go+' Minuten'}
        else {
          var hours_to_go=Math.floor(minutes_to_go/60);
          if (hours_to_go<12) {time_to_go_till_event_starts='noch '+hours_to_go+':'+((minutes_to_go%60>9)?minutes_to_go%60:'0'+minutes_to_go%60)+' Stunden'}
          else if (hours_to_go<24) {time_to_go_till_event_starts='noch '+Math.round(minutes_to_go/60)+' Stunden'}
          else {
            var days_to_go=Math.floor((new Date(e.datetime)-new Date().setHours(0,0,0,0))/86400000);
            if (days_to_go==1) {time_to_go_till_event_starts='startet morgen'} else {
              time_to_go_till_event_starts='noch '+days_to_go+' Tage';
            }
          }
        }
        if (time_to_go_till_event_starts!='') {time_to_go_till_event_starts=' | '+time_to_go_till_event_starts}

        var attendees_counter=(e.attendees?'<div class="attendeescount_wrapper">'+(e.attendees?e.attendees.length:0)+' Teilnehmer'+time_to_go_till_event_starts+'</div>':'');
        var peoples_list_container='<div id="peoples_list_container_'+event_counter+'">'+peoples_list+'</div>';
        var day=['So','Mo','Di','Mi','Do','Fr','Sa'][new Date(e.datetime).getDay()]+' '+e.datetime.substring(8,10)+'.'+e.datetime.substring(5,7)+'. '+e.datetime.substring(11,16)+' Uhr';

        // show content
        var ondblclick='';
        if ((team.userlevel)&&(team.userlevel>1)) {ondblclick=" ondblclick=\"show_teamCommentEdit_prompt(\'"+e.datetime+"\',\'"+(e.comment?e.comment:'')+"\',"+(e.cancelled?true:false)+")\"";}
        
        var banner='<div id="div'+e.datetime+'" class="statusbutton_wrapper"'+ondblclick+'>';
        if ( (event_counter==-1) && (e.attendees&&e.attendees.includes(name)) ) {
          // Teaser / coming up next...
          banner_text='Sei dabei!';
          if (e.attendees&&e.attendees.includes(name)) {banner_text='Du bist dabei!'}
          else if (e.refusals&&e.refusals.includes(name)) {banner_text='Schade!'} 
          banner='<div class="banner">'+banner_text+'</div><div class="statusbutton_wrapper_after_banner">';
        }

        // events
        mobile_main.innerHTML+=banner+'<button id="status'+e.datetime+'" onclick=toggleStatus("'+e.datetime+'")>'+day+'</button><br>'+comment_important+comment_inline+peoples_list_container+attendees_counter+'</div>';
        document.getElementById('peoples_list_container_'+event_counter).className='statusbutton_wrapper_attendees_following';
        // set button-attributes to represent the state of attendence
        if (e.attendees&&e.attendees.includes(name)) {document.getElementById('status'+e.datetime).className='statusbutton_attending'}
        else if (e.refusals&&e.refusals.includes(name)) {document.getElementById('status'+e.datetime).className='statusbutton_refused'} 
        else {document.getElementById('status'+e.datetime).className='statusbutton_undecided'}

      }):false;

      debug('Team-JSON: '+JSON.stringify(team));
    }    
  }

  if ((!team.userlevel)||(team.userlevel<2)) {admin_menu=''}
  mobile_options.innerHTML='<div class="options_wrapper">'+menu+admin_menu+'</div>'; //+admin_options_button
}

function show_teamPreference_prompt(text,param,preval,subline) {
  var e=document.getElementById('mobile_prompt');
  e.innerHTML='<div class="prompt_wrapper"><div class="prompt_text_top">'+text+'</div><input type="hidden" id="teamid" value="'+window.location.pathname.substr(1)+'" autocomplete="off"><input type="text" id="'+param+'" value="'+preval+'" placeholder="" autocomplete="off"><button class="button_ok" onclick="editTeam();hide_prompt();">ok</button><div style=clear:both></div><div class="prompt_text_bottom">'+(subline?subline+'<br>':'')+'<br><a href=javascript:hide_prompt()>Abbrechen</a></div></div>';
  document.getElementById('mobile_inner').style.display='none';
  e.style.display='block';
  document.getElementById(param).focus();
}
function show_teamPreferenceDatetime_prompt() {
  var e=document.getElementById('mobile_prompt');
  e.innerHTML='<div class="prompt_wrapper"><div class="prompt_text_top"><b>Wann</b> findet der Termin statt?</div><input type="hidden" id="teamid" value="'+window.location.pathname.substr(1)+'" autocomplete="off">'+team_datetime_selection+'<button class="button_ok" onclick="editTeam();hide_prompt();">ok</button><div style=clear:both></div><div class="prompt_text_bottom"><br><a href=javascript:hide_prompt()>Abbrechen</a></div></div>';
  document.getElementById('mobile_inner').style.display='none';
  e.style.display='block';
  display_hour_selection();
}
function show_teamDeleteTeam_prompt() {
  var e=document.getElementById('mobile_prompt');
  e.innerHTML='<div class="prompt_wrapper"><div class="prompt_text_top">Möchtest du dieses Team unwiderruflich <b>löschen</b>?<br><br><i>'+team.name+'</i></div><input type="hidden" id="teamid" value="'+window.location.pathname.substr(1)+'" autocomplete="off"><button class="button_ok" onclick="deleteTeam();hide_prompt();">Team löschen</button><div style=clear:both></div><div class="prompt_text_bottom"><br><a href=javascript:hide_prompt()>Abbrechen</a></div></div>';
  document.getElementById('mobile_inner').style.display='none';
  e.style.display='block';
}
function show_teamAddEvent_prompt() {
  var e=document.getElementById('mobile_prompt');
  e.innerHTML='<div class="prompt_wrapper"><div class="prompt_text_top"><b>Wann</b> findet der Termin statt?</div><input type="hidden" id="teamid" value="'+window.location.pathname.substr(1)+'" autocomplete="off"><input type="text" id="datetime" value="'+getDateString()+'T00:00" placeholder="datetime" autocomplete="off"><div class="prompt_text_top"><b>Hinweis</b> zum Termin:</div><input type="text" id="comment" value="Einzeltermin" placeholder="Angabe erforderlich" autocomplete="off"><button class="button_ok" onclick="addEvent();hide_prompt();">ok</button><div style=clear:both></div><div class="prompt_text_bottom"><br><a href=javascript:hide_prompt()>Abbrechen</a></div></div>';
  document.getElementById('mobile_inner').style.display='none';
  e.style.display='block';
  document.getElementById('datetime').focus();
}
function show_teamCommentEdit_prompt(datetime,preval_comment,cancelled) {
  var e=document.getElementById('mobile_prompt');
  e.innerHTML='<div class="prompt_wrapper"><div class="prompt_text_top"><b>Hinweis</b> zum Termin:</div><input type="hidden" id="teamid" value="'+window.location.pathname.substr(1)+'" autocomplete="off"><input type="text" id="comment'+datetime+'" value="'+preval_comment+'" placeholder="" autocomplete="off"><button class="button_ok" onclick="commentEvent(\''+datetime+'\');hide_prompt();">ok</button><div style=clear:both></div><div style="bgcolor:#f0f;padding-top:20px"><input type="checkbox" id="cancelled'+datetime+'"'+(cancelled?' checked':'')+' onclick="cancelORreviveEvent(\''+datetime+'\');" style="float:left"><div style="font-size:0.7em;margin-top:2px">TERMIN FÄLLT AUS</div></div><div class="prompt_text_bottom"><br><a href=javascript:hide_prompt()>Abbrechen</a></div></div>';
  document.getElementById('mobile_inner').style.display='none';
  e.style.display='block';
  document.getElementById('comment'+datetime).focus();
}

function display_hour_selection() {
	var viewstate='inline';
  var element_weekday=document.getElementById('weekday');
  if (element_weekday) {
    if (element_weekday.value==8) {viewstate='none'}
    document.getElementById('hour').style.display=viewstate;
    document.getElementById('minute').style.display=viewstate;    
  }
}

function toggleStatus(datetime) {
  var e=findEvent(team,datetime);
  var name=getCookie('name',true);
  if (e.attendees&&e.attendees.includes(name)) {changeStatus("refuse",datetime)}
  else if (e.refusals&&e.refusals.includes(name)) {changeStatus("undecided",datetime)} 
  else {changeStatus("attend",datetime)}
}

function toggleView(id,state) {
  var e=document.getElementById(id);
  if (state) {e.style.display=state} 
  else if (e.currentStyle?e.currentStyle.display=='none':getComputedStyle(e, null).display=='none') {e.style.display='block'} else {e.style.display='none'}
}

function findEvent(team,datetime) {
  if (team.events instanceof Array) {
    return team.events.find(function(e) {return e.datetime==datetime})||false;
  } else {return false}
}

function updateStatus(json) {
  debug('The server answered: '+json);
  var o=JSON.parse(json);
  getTeam(o.teamid?o.teamid:'');
}

function getTeam(teamid) {
  if (!teamid) {teamid=window.location.pathname.substr(1)}
  if (teamid) {
    // check if current URL matches with requested teamid
    if (teamid!=window.location.pathname.substr(1)) {
      // if not, relocate
      window.location.href=window.location.href.split('/')[0]+teamid;
    } else {
      // else, request team-data
      serverRequest('getTeam',{token:getCookie('token',true),teamid:teamid},function (r){updateView(r)});
    }
  } else {updateView()}
}

function changeStatus(status,datetime) {
  // prompt for name if name is not set
  // since this DOM-client-prompt-fake does not have a callback-option, recall this function via js-injection
  if (!getCookie('name',true)) {
    show_cookie_prompt('name','changeStatus(\''+status+'\',\''+datetime+'\');');
  } else {
    serverRequest(status,{token:getCookie('token',!team.teamtoken),teamid:window.location.pathname.substr(1),datetime:datetime,name:getCookie('name')},function (r){updateStatus(r);});
  }
}

function addTeam() {
  serverRequest('addTeam',{teamid:document.getElementById('teamid').value,name:document.getElementById('name').value,teamtoken:document.getElementById('teamtoken').value,admintoken:document.getElementById('admintoken').value,recurrence:[{weekday:document.getElementById('weekday').value,time:document.getElementById('hour').value+':'+document.getElementById('minute').value}]},function (r){if (JSON.parse(r).hasOwnProperty('teamid')) {window.location.href = '/'+document.getElementById('teamid').value;} else {debug(r)}});
}

function editTeam() {
  serverRequest('editTeam',{token:getCookie('token',true),teamid:document.getElementById('teamid')?document.getElementById('teamid').value:undefined,new_teamid:document.getElementById('new_teamid')?document.getElementById('new_teamid').value:undefined,name:document.getElementById('name')?document.getElementById('name').value:undefined,teamtoken:document.getElementById('teamtoken')?document.getElementById('teamtoken').value:undefined,admintoken:document.getElementById('admintoken')?document.getElementById('admintoken').value:undefined,recurrence:document.getElementById('weekday')&&document.getElementById('hour')&&document.getElementById('minute')?[{weekday:document.getElementById('weekday').value,time:document.getElementById('hour').value+':'+document.getElementById('minute').value}]:undefined},function (r){updateStatus(r);});
}

function deleteTeam() {
  serverRequest('deleteTeam',{token:getCookie('token',true),teamid:document.getElementById('teamid').value},function (r){updateStatus(r);toggleView('mobile_options','none');toggleView('mobile_main','block');});
}

function addEvent() {
  serverRequest('addEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:document.getElementById('datetime').value,comment:document.getElementById('comment').value},function (r){updateStatus(r);});
}

function cancelORreviveEvent(datetime) {
  //console.log(document.getElementById('cancelled'+datetime).checked);
  if (document.getElementById('cancelled'+datetime).checked) {cancelEvent(datetime)} else {reviveEvent(datetime)}
}

function cancelEvent(datetime) {
  serverRequest('cancelEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r);});
}

function reviveEvent(datetime) {
  serverRequest('reviveEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r);});
}

function commentEvent(datetime) {
  serverRequest('commentEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime,comment:document.getElementById('comment'+datetime).value},function (r){updateStatus(r);});
}

function deleteEvent(datetime) {
  serverRequest('deleteEvent',{token:getCookie('token',true),teamid:window.location.pathname.substr(1),datetime:datetime},function (r){updateStatus(r);});
}

function load() {
  serverRequest('load',{token:getCookie('token',true)},function (r){updateStatus(r);});
}

function save() {
  serverRequest('save',{token:getCookie('token',true)},function (r){updateStatus(r);});
}

function dump() {
  serverRequest('dump',{token:getCookie('token',true)},function (r){updateStatus(r);});
}

function getDateString(d) {
  if (!d) {d=new Date()}
  var tzoffset = d.getTimezoneOffset() * 60000;
  return (new Date(d-tzoffset)).toISOString().slice(0, -14);
} 

function serverRequest(apicall,json,callback) {
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {if (this.readyState == 4) {callback(this.responseText)}};
  req.open("POST","/api/"+apicall,true);
  req.setRequestHeader("Content-Type","application/json;charset=UTF-8");
  req.send(JSON.stringify(json));
}

function getCookie(cname,dontask) {
  var name = cname + "=";
  var ca = document.cookie.split(';');
  for(var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      var res=c.substring(name.length, c.length);
      return res;
    }
  }
  if (dontask) {return} else {return askCookie(cname)}
}

function askCookie(cname) {
  var preval=getCookie(cname,true);
  var val = prompt("Please enter "+cname, preval);
  return setCookie(cname, val, 365); //-1 = sessioncookie
  //show_cookie_prompt(cname);
}
function show_cookie_prompt(cname,str_functionToCall) {
  var text='???';
  var placeholder='';
  var preval=(getCookie(cname,true)||'');
  if (cname=='name') {text='Bitte gib deinen <b>Namen</b> ein:'; placeholder='Name';}
  else if (cname=='token') {text='Bitte gib deinen <b>Token</b> ein:'; placeholder='Token';}
  var e=document.getElementById('mobile_prompt');
  e.innerHTML='<div class="prompt_wrapper"><div class="prompt_text_top">'+text+'</div><input type="text" id="cinput" value="'+preval+'" placeholder="'+placeholder+'" autocomplete="off"><button class="button_ok" onclick="setCookie(\''+cname+'\',document.getElementById(\'cinput\').value,365);hide_prompt();'+(str_functionToCall||'')+'">ok</button><div style=clear:both></div><div class="prompt_text_bottom">Diese Information wird als Cookie in deinem Browser gespeichert.<br><br><a href=javascript:hide_prompt()>Abbrechen</a></div></div>';
  document.getElementById('mobile_inner').style.display='none';
  e.style.display='block';
  document.getElementById('cinput').focus();
}

function setCookie(cname, cvalue, exdays) {
  var expires='';
  if (cvalue==""||cvalue==null) {exdays=0} //0 = delete cookie
  if (exdays>=0) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    expires = "expires="+d.toUTCString();
  }
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  getTeam();
  return getCookie(cname,true);
}

function debug(text) {
  console.log(text);
}

is_mobile=1;
function check_mobile() 
{
  var old_mobile_status=is_mobile;
  var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
  var height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
  if ( (width<=1024) && (is_mobile!=-1) )//|| ((display_state(document.getElementById('mobile'))==='block')&&(is_mobile!=-1)) ) 
  {
    is_mobile=1;
    //console.log('mobile YES');
    //document.getElementById('under_mobile').style.display='none';
    document.getElementById('mobile').style.maxWidth='100vw';
    document.getElementById('mobile').style.height='100vh';
    document.getElementById('mobile').style.top=0;
    document.querySelector("meta[name=viewport]").setAttribute('content','initial-scale=1');
  }
  else 
  {
    if (is_mobile>0) {is_mobile=0}
    //console.log('mobile NO');
    //document.getElementById('under_mobile').style.display='block';
    document.getElementById('under_mobile').style.backgroundImage='url(images/phone.svg)';
    if (!document.getElementById("logoutIMG")) {
      var img = document.createElement("IMG");
      img.id='logoutIMG';
      img.src='/images/logout.svg';
      img.style.position='fixed';
      img.style.bottom='10px';
      img.style.right='10px';
      img.style.width='60px';
      document.getElementById('under_mobile').appendChild(img);
      //<img src="/images/logout.svg" style="position:fixed;bottom:10px;right:10px;width:60px">
    }
    
    var width=380; 
    document.getElementById('mobile').style.maxWidth=width+'px'; 
    document.getElementById('under_mobile').style.backgroundSize=width+58+'px 100%';
    document.getElementById('mobile').style.height='85%';
    document.getElementById('mobile').style.top='8%';
    document.querySelector("meta[name=viewport]").setAttribute('content','width=1024,initial-scale=1');
  }
  if (old_mobile_status!=is_mobile) {}
}

function hide_prompt(text,preval) {
  document.getElementById('mobile_prompt').style.display='none';
  document.getElementById('mobile_inner').style.display='block';
}

</script>

<style>
/* roboto-slab-regular - latin-ext */
/* 
@font-face {
  font-family: 'Roboto Slab';
  font-style: normal;
  font-weight: 400;
  font-display: fallback;
  src: url('/fonts/roboto-slab-v7-latin-ext-regular.eot');
  src: local('Roboto Slab Regular'), local('RobotoSlab-Regular'),
       url('/fonts/roboto-slab-v7-latin-ext-regular.eot?#iefix') format('embedded-opentype'),
       url('/fonts/roboto-slab-v7-latin-ext-regular.woff2') format('woff2'), 
       url('/fonts/roboto-slab-v7-latin-ext-regular.woff') format('woff'),
       url('/fonts/roboto-slab-v7-latin-ext-regular.ttf') format('truetype'), 
       url('/fonts/roboto-slab-v7-latin-ext-regular.svg#RobotoSlab') format('svg');
}
*/
/* roboto-regular - latin-ext */
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 400;
  font-display: block; //fallback
  src: url('/fonts/roboto-v18-latin-ext-regular.eot'); /* IE9 Compat Modes */
  src: local('Roboto'), local('Roboto-Regular'),
       url('/fonts/roboto-v18-latin-ext-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('/fonts/roboto-v18-latin-ext-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('/fonts/roboto-v18-latin-ext-regular.woff') format('woff'), /* Modern Browsers */
       url('/fonts/roboto-v18-latin-ext-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('/fonts/roboto-v18-latin-ext-regular.svg#Roboto') format('svg'); /* Legacy iOS */
}
  * {-webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;}
  body {padding:0; margin:0; background-color:#fff;font-family: 'Roboto', serif; font-size: 1.6em; color:#000; background-color:#c2c2c2;}
  /*
    green #86E082 #5BCF55 #3BBA34 #1DA416 #0E8108
    red   #FE9395 #FD686C #E34044 #C81B20 #9E090D
    brown #FFC393 #FFAC69 #E58A41 #CA691B #A04C0A
    blue  #6FBFBC #409B98 #278B87 #117B77 #06615E
  */
  .bigscreen {
    height:100vh;
    position:relative;
  }
  .under_mobile {
    display:none;
    position:fixed;
    z-index:-1;
    width:100%; height:100%;
    //background: url(images/phone.svg);
    background-repeat: no-repeat;
    background-position: top center;
    background-size: 490px 100%;
  }
  .mobile {z-index:1; background-color: #c2c2c2; padding:0; position:relative; overflow:auto; margin:auto;}
  .mobile_prompt {
    z-index:2;
    overflow:auto;
    margin:auto;
    position: relative;
    display: none;
    padding: 3px;
  }
  .mobile_inner {padding: 3px}
    .head {}
    .main {overflow:hidden; overflow-wrap:break-word;}
    .options {display:none;}
    .admin {display:none}
    .footer {}

  a {color:inherit}
  a:hover {color:rgb(0,0,0); nobackground-color:rgb(245,0,0); notext-decoration:none; nopadding: 0 0.5em 0 0.5em; noborder-radius: 0.2em;}
  select, input, button {font-family: 'Roboto', serif; font-size: 1em; padding: 0 0.5em 0 0.5em; border-style: none; border-radius: 0.1em; background-color:rgb(235,235,235); outline:0; height:50px; margin:0 0 0.4em 0;}
 
  input {display:inline; width:100%}
  input[type='checkbox'] {width:1em; height:1em; margin:0 9px 0.4em 9px;}
  
  button {
    border-radius: 0.1em;
    position: relative; overflow: hidden; display:inline-block; cursor: pointer; 
    background-color:#A2A2A2; background-image:linear-gradient(#A2A2A2 84%,#A2A2A2 0%);
    margin: 0 0px 0px 0;
    height:50px; letter-spacing: -0.9px; notext-transform: uppercase; text-align: center;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.16), 0 1px 1px rgba(0, 0, 0, 0.1);
  }
  button:before {
    -webkit-transition: 0.22s all ease;
    transition: 0.22s all ease;
    position: absolute;
    top: 92%;
    left: 0;
    bottom: 0;
    content: '';
    background-color: #000;
    opacity: 0.4;
    z-index: 2;
  }
  button:hover:before {
    top: 84%;
    right: 0;
    opacity: 0.24;
  }

  div.head_wrapper {
    border-radius: 0.1em; margin: 6px 6px 0px 6px; padding: 9px 9px 0px 9px; nobackground-color:#fff; text-align: left; min-height:72px;
  }
  div.new_team_wrapper {
    border-radius: 0.1em; margin: 6px 6px 0px 6px; padding: 0px 9px 0px 9px; nobackground-color:#fff; text-align: left;
  }
  div.teamlist_wrapper {
    border-radius: 0.1em; margin: 6px 6px 20px 6px; padding: 9px 9px 9px 9px; nobackground-color:#fff; text-align: left; font-size: 0.7em;
  }
  div.error_wrapper {
    border-radius: 0.1em; border-style:solid; border-width:0px; border-color:#9E090D; margin: 5px 6px 6px 6px; padding:28px 22px 42px 22px; background-color:#fff; text-align: center;
  }
  div.error_text {
    nobackground-color:#9E090D; font-size: 0.7em;
  }
  div.error_code {
    font-family: monospace; font-size: 0.7em;
  }
  div.options_wrapper {
    border-radius: 0.1em; margin: 5px 6px 6px 6px; padding: 0px 0px 0px 0px; nobackground-color:#ccc; text-align: left;
  }
  div.options_option {
    border-radius: 0.1em; margin:0px 0px 9px 0px; padding: 9px 9px 9px 9px; background-color: #fff; min-height:68px; overflow: wrap;
  }
  div.option_text {
    font-size:0.7em; padding:0px 0px 4px 0px;
  }
  button.option_button {
    float:right; margin:0px 0px 0px 8px; height: 50px; width: 50px;
  }
  div.divider {
    border-radius: 0.1em; margin:0px 0px 0px 0px; padding: 9px 9px 9px 9px; nobackground-color: #fff; min-height:10px; overflow: wrap; font-size: 0.7em;
  }
  div.admin_wrapper {
    border-radius: 0.1em; margin: 0px 6px 12px 6px; padding: 0px 6px 0px 9px; nobackground-color:#ddd; text-align: left;
  }
  div.attendeescount_wrapper {
    padding: 6px 6px; text-align: center; font-size:1em;
  }
  div.comment_wrapper {
    background-color: #fff; margin: 0px 0px 6px 0px; padding: 0px; text-align: center; display:inline-block; width:90%; 
  }
  div.comment_important {
    border-radius: 0.1em; background-color:#E81B20; color:#fff; margin: 0px 0px 6px 0px; padding: 5px; text-align: center; display:inline-block; width:80%; 
  }
  div.footer_wrapper {
    border-radius: 0.1em; margin: 6px 6px 20px 6px; padding: 9px 9px 9px 9px; nobackground-color:#fff; text-align: left;
  }
  div.banner {
    border-radius: 0.1em 0.1em 0em 0em; margin: -10px 0px 0px 15px; padding: 8px 16px 6px 16px; position:absolute; display:inline; overflow:hidden; white-space: nowrap; color:#fff; background-color:#20609f; text-align: center; font-size:0.6em; noletter-spacing: 0.5px;
  }
  div.statusbutton_wrapper_after_banner {
    border-radius: 0.1em; margin: 22px 6px 12px 6px; padding: 20px 0 10px 0; background-color:#fff; text-align: center; font-size:0.7em;
  }
  div.statusbutton_wrapper {
    border-radius: 0.1em; margin: 5px 6px 12px 6px; padding: 20px 0 10px 0; background-color:#fff; text-align: center; font-size:0.7em;
  }
  div.prompt_wrapper {
    border-radius: 0.1em; margin: 12px 6px 12px 6px; padding: 20px 16px 20px 16px; background-color:#fff; text-align: left;
  }
  div.prompt_text_top {
    font-size:0.7em; width:100%; text-align:left; padding:0px 10px 10px 10px;
  }
  div.prompt_text_bottom {
    font-size:0.7em; width:100%; text-align:left; padding:10px 10px 10px 10px;
  }

  button.statusbutton_undecided, button.statusbutton_attending, button.statusbutton_refused {
    cursor: pointer; width:80%; margin:0px 0px 8px 0px; font-size:1.4em; noletter-spacing: 0.2px;
  }
  button.statusbutton_undecided {color:#000; background-color:#ffbf00; background-image:linear-gradient(#ffbf00 84%,#efaf00 0%);}
  button.statusbutton_attending {color:#000; background-color:#1DA416; background-image:linear-gradient(#1DB416 84%,#1DA416 0%);}
  button.statusbutton_refused   {color:#000; background-color:#C81B20; background-image:linear-gradient(#E81B20 84%,#D81B20 0%);}

  //button.button_cancel {float:left; color:#808080; background-image:linear-gradient(#f0f0f0 80%, #f0f0f0 0%);}
  button.button_ok {float:right; margin-right:0px; width:100%; nobackground-image:linear-gradient(#1DB416 84%,#1DA416 0%);}

  div.statusbutton_wrapper_attendees_first {padding:8px;}
  div.statusbutton_wrapper_attendees_following {background-color: #fff; padding:8px 8px 0px 8px;}
  div.attendee_item, div.refusal_item {display:inline-block; white-space: nowrap; background-color:#ddd; border-radius: 0.1em; padding:4px; margin:0px 4px 8px 4px;}
  div.attendee_item {nocolor:#1DA416;}
  div.refusal_item {color:#999; nocolor:#C81B20; text-decoration:line-through;}
  

/* Extra small devices (phones, 600px and down) */
@media only screen and (max-width: 600px) {} 

/* Small devices (portrait tabvars and large phones, 600px and up) */
@media only screen and (min-width: 600px) {} 

/* Medium devices (landscape tabvars, 768px and up) */
@media only screen and (min-width: 768px) {} 

/* Large devices (laptops/desktops, 992px and up) */
@media only screen and (min-width: 1024px) {
  body {
    //background-color:#1DB416; 
    background-image:linear-gradient(#1DB416 78%, #1DA416 0%);
  }
  .mobile {
    border-radius: 0em;
  }
  .under_mobile {
    display:block;
  }
} 

/* Extra large devices (large laptops and desktops, 1200px and up) */
@media only screen and (min-width: 1200px) {}

</style>

</head>
<body onload="getTeam();check_mobile();" onresize="check_mobile()">

<div id="bigscreen" class="bigscreen">
  <div id="under_mobile" class="under_mobile" display="none"></div>
  <div id="mobile" class="mobile">
    <div id="mobile_prompt" class="mobile_prompt"></div>
    <div id="mobile_inner" class="mobile_inner">
      <div id="mobile_head" class="head"></div>
      <div id="mobile_options" class="options"></div>
      <!--<div id="mobile_admin" class="admin"></div>-->
      <div id="mobile_main" class="main"></div>
      <div id="mobile_footer" class="footer"></div>
    </div>
  </div>
</div>
<!--<audio id="audio" no_controls="" no_autoplay><source src="sounds/smb_kick.wav" type="audio/wav">audio not supported</audio><button onclick=document.getElementById("audio").play()>play audio</button>-->

</body>

</html>
